# DeepSeek OCR GUI - 跨平台开发和打包指南

## 🎯 您的场景：Linux 开发 + Windows 部署

### 优势
- ✅ Linux 上 vLLM 完美支持
- ✅ Flash Attention 2 可用
- ✅ GPU 加速完整
- ✅ 开发和测试环境完整

### 挑战
- ⚠️ PyInstaller 只能在目标平台打包
- Linux 打包 → Linux 可执行文件
- Windows 打包 → Windows EXE

---

## 📋 推荐工作流程

### 阶段 1：Linux 上开发和测试 🐧

#### 1.1 环境准备

```bash
# 确保有 X11 显示
export DISPLAY=:0

# 如果是远程服务器，使用 X11 转发
ssh -X user@linux-server

# 或使用 VNC/X2Go 等远程桌面
```

#### 1.2 安装依赖

```bash
cd ~/DeepSeek-OCR/DeepSeek-OCR-master/DeepSeek-OCR-vllm

# 安装 vLLM 和依赖
pip install vllm
pip install transformers
pip install PyMuPDF  # PDF 支持
pip install pillow
pip install torch

# 安装 tkinter (如果没有)
# Ubuntu/Debian
sudo apt-get install python3-tk

# CentOS/RHEL
sudo yum install python3-tkinter

# Arch Linux
sudo pacman -S tk
```

#### 1.3 运行 GUI

```bash
# 方法 1: 使用测试脚本
chmod +x test_gui_linux.sh
./test_gui_linux.sh

# 方法 2: 直接运行
python3 gui_ocr_vllm.py
```

#### 1.4 测试所有功能

- [ ] 加载模型
- [ ] 单图识别
- [ ] PDF 处理
- [ ] 批量处理
- [ ] 结果保存
- [ ] 界面响应

---

### 阶段 2：代码传输到 Windows 🔄

#### 方法 A: Git（推荐）

```bash
# 在 Linux 上
git add .
git commit -m "Updated vLLM GUI - tested on Linux"
git push origin main

# 在 Windows 上
git pull origin main
```

#### 方法 B: SCP/SFTP

```bash
# 从 Linux 传到 Windows
scp gui_ocr_vllm.py user@windows-pc:C:/path/to/project/

# 或使用 WinSCP、FileZilla 等工具
```

#### 方法 C: 网络共享

```bash
# 将 Windows 文件夹挂载到 Linux
# 或将 Linux 文件夹共享给 Windows
```

#### 方法 D: U盘/云盘

```bash
# 复制到 U 盘或上传到云盘
# OneDrive, Google Drive, Dropbox 等
```

---

### 阶段 3：Windows 上打包 🪟

#### 3.1 在 Windows 上安装环境

```powershell
# 激活 conda 环境
conda activate deepseek-ocr

# 安装依赖（如果还没有）
pip install transformers
pip install PyMuPDF
pip install pillow
pip install pyinstaller
```

#### 3.2 测试代码

```powershell
# 确保在 Windows 上也能运行
cd C:\path\to\DeepSeek-OCR\DeepSeek-OCR-master\DeepSeek-OCR-vllm
python gui_ocr_vllm.py
```

#### 3.3 打包为 EXE

```powershell
# 返回项目根目录
cd C:\path\to\DeepSeek-OCR

# 运行打包脚本
python build_exe.py

# 或者使用 quick_build.bat
quick_build.bat
```

#### 3.4 测试 EXE

```powershell
# 运行打包后的程序
cd dist\DeepSeekOCR
.\DeepSeekOCR.exe
```

---

## 🔧 跨平台注意事项

### 1. 文件路径处理

```python
# ❌ 错误 - 硬编码 Windows 路径
path = "C:\\Users\\..."

# ✅ 正确 - 使用 os.path 或 pathlib
from pathlib import Path
path = Path.home() / "Documents"

# ✅ 使用 os.path.join
path = os.path.join(base_dir, "output")
```

### 2. 文件打开方式

```python
# ✅ 已在代码中实现跨平台支持
if sys.platform == 'win32':
    os.startfile(path)
elif sys.platform == 'darwin':
    subprocess.Popen(['open', path])
else:  # Linux
    subprocess.Popen(['xdg-open', path])
```

### 3. 行尾符

```bash
# Git 配置自动转换
git config --global core.autocrlf input  # Linux
git config --global core.autocrlf true   # Windows
```

---

## 🚀 高级方案：使用 GitHub Actions

如果频繁打包，可以使用 CI/CD 自动化：

### .github/workflows/build.yml

```yaml
name: Build EXE

on:
  push:
    branches: [ main ]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          pip install pyinstaller
          pip install -r requirements.txt
      - name: Build EXE
        run: python build_exe.py
      - uses: actions/upload-artifact@v3
        with:
          name: DeepSeekOCR-Windows
          path: dist/DeepSeekOCR/
```

这样每次 push 代码，GitHub 会自动在 Windows 上打包。

---

## 📊 性能对比

| 环境 | vLLM | Flash Attention | 速度 |
|------|------|----------------|------|
| **Linux (开发)** | ✅ | ✅ | ⚡⚡⚡⚡⚡ |
| **Windows (部署)** | ❌ | ⚠️ | ⚡⚡⚡ |

**建议：**
- Linux 上开发测试（使用 vLLM 获得最佳性能）
- Windows 打包使用 HF Transformers（兼容性好）

---

## 🐛 常见问题

### Q1: Linux 上 GUI 无法显示
```bash
# 检查 DISPLAY
echo $DISPLAY

# 设置 DISPLAY
export DISPLAY=:0

# 或使用 VNC
vncserver :1
export DISPLAY=:1
```

### Q2: Windows 上打包后无法运行
```powershell
# 检查依赖是否完整
pyinstaller --clean DeepSeekOCR.spec

# 查看错误日志
dist\DeepSeekOCR\DeepSeekOCR.exe
```

### Q3: 文件传输编码问题
```bash
# 使用 UTF-8 编码
# 检查文件编码
file -i *.py

# 转换编码
iconv -f ISO-8859-1 -t UTF-8 file.py > file_utf8.py
```

---

## ✅ 检查清单

### Linux 开发阶段
- [ ] vLLM 正常加载
- [ ] GUI 能够显示
- [ ] 模型加载成功
- [ ] 单图识别正常
- [ ] PDF 处理正常
- [ ] 批量处理正常
- [ ] 代码使用相对路径
- [ ] 没有 Linux 特定的硬编码

### Windows 打包阶段
- [ ] 代码传输完成
- [ ] Windows 上能够运行
- [ ] PyInstaller 已安装
- [ ] 打包成功（无错误）
- [ ] EXE 能够启动
- [ ] 所有功能正常
- [ ] 在干净的 Windows 上测试

---

## 📝 总结

### 可行性：✅ 完全可行

**工作流程：**
```
Linux 开发 → 测试完善 → 传输代码 → Windows 打包 → 分发部署
```

**关键点：**
1. 代码必须跨平台兼容（已修改）
2. 不能在 Linux 上直接打包 Windows EXE
3. 需要在 Windows 上完成最终打包
4. 可以使用 GitHub Actions 自动化

**您的优势：**
- ✅ Linux 环境完整（vLLM + GPU + Flash Attention）
- ✅ 可以高效开发和测试
- ✅ Windows 只用于打包

这是一个非常好的开发策略！🎉
